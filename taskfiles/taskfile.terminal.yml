version: '3'

tasks:

  # The purpose of this file is to encapsulate all the operations related to neovim
  # from installation, to stow operations
  # Some special care is required since it should be usable in macos and linux
  # NOTE: the folder creation is required for stow ignore to work!
  # TODO: Zsh configuration is missing from this file

  default:
    internal: true
    desc: Default
    cmds:
      - |
        echo "Working dir: {{.USER_WORKING_DIR}}"
        echo "OS: {{OS}}"
        task --list
    silent: true

  assert:
    cmds:
      - for:
          var: REQUIRED_TOOLS
          split: ','
          as: TOOL
        cmd: |
          [ -n "$(which {{ .TOOL }})" ] || ( \
            echo "ERROR: `{{ .TOOL }}` not found" && exit 1; \
          )
    silent: true
    internal: true

  terminal:
    desc: Setup terminal and shell
    cmds:
      - task: installation_linux
      - task: installation_macos
      - task: cleanup
      - task: directories
      - task: stow

  installation_linux:
    internal: true
    platforms: [linux]
    desc: Install terminal and shell dependencies
    cmds:
      - task: assert
        vars:
          REQUIRED_TOOLS: bash, pacman
      - "{{.ROOT_DIR}}/taskfiles/scripts/03-pacman-terminal.sh"

  installation_macos:
    internal: true
    platforms: [darwin]
    desc: Install terminal and shell dependencies with brew
    cmds:
      - task: assert
        vars:
          REQUIRED_TOOLS: bash, brew
      - "{{.ROOT_DIR}}/taskfiles/scripts/03-brew-terminal.sh"

  cleanup:
    internal: true
    desc: Delete existent shell configuration
    cmds:
      - rm -rf {{.HOME}}/.bashrc
      - rm -rf {{.HOME}}/.bash_profile
      - rm -rf {{.HOME}}/.bash_logout
      - rm -rf {{.HOME}}/.config/fish
      - rm -rf {{.HOME}}/.zshrc

  directories:
    internal: true
    desc: Create required directories
    cmds:
      - mkdir -p {{.HOME}}/.config/fish
      - mkdir -p {{.HOME}}/.config/ghostty
      - mkdir -p {{.HOME}}/.config/kitty
      - mkdir -p {{.HOME}}/.config/zsh

  stow:
    desc: Symlink terminal and shell configuration
    cmds:
      - task: stow_linux
      - task: stow_macos

  stow_linux:
    internal: true
    platforms: [linux]
    desc: Symlink terminal and shell configuration for linux
    cmds:
      - task: assert
        vars:
          REQUIRED_TOOLS: stow
      - "stow --restow --verbose --dir={{.ROOT_DIR}} --target={{.HOME}} terminal --ignore='.*macos.conf'"

  stow_macos:
    internal: true
    platforms: [darwin]
    desc: Symlink terminal and shell configuration for linux
    cmds:
      - task: assert
        vars:
          REQUIRED_TOOLS: stow
      - "stow --restow --verbose --dir={{.ROOT_DIR}} --target={{.HOME}} terminal --ignore='.*linux.conf'"

  destow:
    desc: Delete symlink terminal and shell configurations
    cmds:
      - task: assert
        vars:
          REQUIRED_TOOLS: stow
      - "stow --delete --verbose --dir={{.ROOT_DIR}} --target={{.HOME}} terminal"
